<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>PAVITRAX | Smart Waste-Segregation Boat</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <link rel="stylesheet" href="./app.css"/>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>
</head>
<body>
  <header>
    <div class="brand">
      <div class="logo">P</div>
      PAVITRAX
    </div>
    <nav id="nav">
      <button data-target="dashboard" class="active">Dashboard</button>
      <button data-target="live">Live Control</button>
      <button data-target="analytics">Analytics</button>
      <button data-target="predictions">Predictions</button>
      <button data-target="reports">Reports</button>
      <button data-target="heatmap">Heatmap</button>
      <button data-target="about">About</button>
    </nav>
  </header>

  <main>
    <!-- Dashboard -->
    <section id="dashboard" class="active">
      <div class="status-bar">
        <div class="card"><div>Status</div><div class="pill success">Online</div></div>
        <div class="card"><div>Battery</div><div id="battery">-- V</div></div>
        <div class="card"><div>GPS Lock</div><div class="pill info">Acquired</div></div>
        <div class="card"><div>Motors</div><div class="pill warn">Active</div></div>
      </div>

      <div class="grid cards-4" style="margin-top:16px;">
        <div class="card"><h3>Boat Location (NEO-6M GPS)</h3><div class="value" id="boat-location">--</div><div class="subtitle" id="boat-heading">Heading: --°</div></div>
        <div class="card"><h3>Speed</h3><div class="value" id="boat-speed">-- m/s</div><div class="subtitle">Propeller motors (L298N)</div></div>
        <div class="card"><h3>Ultrasonic (Waterproof)</h3><div class="value" id="ultrasonic">-- cm</div><span class="pill warn" id="obstacle-pill">Monitoring</span></div>
        <div class="card"><h3>Battery</h3><div class="value" id="battery-val">-- V</div><span class="pill" id="battery-pill">--</span></div>
        <div class="card"><h3>Air Quality (MQ135)</h3><div class="value" id="mq135-value">-- ppm</div><div class="subtitle" id="mq135-pollutants">NH₃, CO₂, NOx, C₆H₆, Benzene</div><span class="pill danger" id="pollution-pill">Monitoring</span></div>
        <div class="card"><h3>Air Quality (MQ2)</h3><div class="value" id="mq2-value">-- ppm</div><div class="subtitle" id="mq2-pollutants">Smoke, Alcohol, LPG, CH₄, Benzene</div></div>
        <div class="card"><h3>Water Temp (DS18B20)</h3><div class="value" id="temp">-- °C</div></div>
        <div class="card"><h3>TDS (Water Health)</h3><div class="value" id="tds-value">-- ppm</div><div class="subtitle" id="tds-status">--</div><span class="pill" id="tds-pill">--</span></div>
        <div class="card"><h3>Moisture (Dry Bin)</h3><div class="value" id="moisture-dry">-- %</div><div class="subtitle">Capacitive sensor</div></div>
        <div class="card"><h3>Moisture (Wet Bin)</h3><div class="value" id="moisture-wet">-- %</div><div class="subtitle">Capacitive sensor</div></div>
        <div class="card"><h3>Bin Weight (HX711)</h3><div class="value" id="weight">-- g</div><span class="pill" id="bin-pill">Capacity ok</span></div>
        <div class="card"><h3>Conveyors (L298N)</h3><div class="value" id="conveyors">Wet: -- | Dry: --</div><div class="subtitle">ESP8266</div></div>
        <div class="card"><h3>Propellers (L298N)</h3><div class="value" id="propellers">Status: --</div><div class="subtitle">ESP8266</div></div>
        <div class="card"><h3>Mode</h3><div class="value" id="mode">--</div><div class="subtitle" id="image-status">ESP32-CAM: Image Processing Only</div></div>
      </div>

      <div class="row" style="margin-top:16px;">
        <div class="card">
          <h3>Boat Map</h3>
          <div id="map"></div>
        </div>
        <div class="card">
          <h3>Stability (ADX)</h3>
          <canvas id="stabilityChart" height="160"></canvas>
        </div>
      </div>

      <div class="card" style="margin-top:16px;">
        <h3>Live Controls</h3>
        <div class="controls-grid">
          <button class="btn" data-cmd="forward">Move Forward</button>
          <button class="btn" data-cmd="left">Move Left</button>
          <button class="btn" data-cmd="right">Move Right</button>
          <button class="btn danger" data-cmd="stop">Stop</button>
          <button class="btn alt" data-cmd="wet_on">Conveyor Wet</button>
          <button class="btn alt" data-cmd="dry_on">Conveyor Dry</button>
          <button class="btn" data-cmd="auto_toggle">Auto Segregation</button>
          <button class="btn" data-cmd="nav_toggle">Auto Navigation</button>
        </div>
      </div>
    </section>

    <!-- Live Control -->
    <section id="live">
      <div class="row">
        <div class="card">
          <h3>Directional Controls</h3>
          <div class="controls-grid">
            <button class="btn" data-cmd="forward">Forward</button>
            <button class="btn" data-cmd="left">Left</button>
            <button class="btn" data-cmd="right">Right</button>
            <button class="btn danger" data-cmd="stop">Stop</button>
          </div>
        </div>
        <div class="card">
          <h3>Live Camera Feed (ESP32-CAM)</h3>
          <div class="subtitle">Streaming...</div>
          <div style="height:240px;background:#0b1224;border-radius:12px;display:grid;place-items:center;color:#94a3b8;">Live stream</div>
        </div>
      </div>
    </section>

    <!-- Analytics -->
    <section id="analytics">
      <div class="grid cards-4">
        <div class="card"><div class="subtitle">Total Waste Collected</div><div class="kpi" id="kpi-waste">-- Kg</div></div>
        <div class="card"><div class="subtitle">Avg TDS Level</div><div class="kpi" id="kpi-tds">-- ppm</div></div>
        <div class="card"><div class="subtitle">Avg Temperature</div><div class="kpi" id="kpi-temp">-- °C</div></div>
        <div class="card"><div class="subtitle">Avg Air Quality</div><div class="kpi" id="kpi-aqi">-- PPM</div></div>
      </div>

      <div class="row" style="margin-top:16px;">
        <div class="card">
          <h3>Daily Waste Collection</h3>
          <canvas id="wasteChart" height="220"></canvas>
        </div>
        <div class="card">
          <h3>TDS Level Trend</h3>
          <canvas id="tdsTrend" height="160"></canvas>
          <h3 style="margin-top:16px;">Water Temperature Trend</h3>
          <canvas id="tempTrend" height="160"></canvas>
          <h3 style="margin-top:16px;">Air Quality (MQ135)</h3>
          <canvas id="aqiTrend" height="160"></canvas>
        </div>
      </div>

      <div class="card" style="margin-top:16px;">
        <h3>Correlation Analysis (TDS vs Waste)</h3>
        <canvas id="correlationChart" height="200"></canvas>
      </div>
    </section>

    <!-- Predictions -->
    <section id="predictions">
      <div class="card">
        <h3>Overall Risk Level</h3>
        <div class="subtitle">Based on predicted TDS, temperature, and air quality trends</div>
        <div style="margin-top:12px;height:36px;background:linear-gradient(90deg,#10b981,#f59e0b,#f97316,#ef4444);border-radius:10px;position:relative;">
          <div style="position:absolute;left:70%;top:-6px;width:12px;height:48px;border-radius:999px;background:#fff;border:2px solid #0f172a;"></div>
        </div>
      </div>
      <div class="card" style="margin-top:16px;">
        <h3>7-Day Waste Generation Forecast</h3>
        <div style="height:260px;background:#f8fafc;border-radius:12px;display:grid;place-items:center;color:#6b7280;">Forecast chart placeholder</div>
      </div>
    </section>

    <!-- Reports -->
    <section id="reports">
      <div class="grid cards-3">
        <div class="card">
          <h3>Report Period</h3>
          <div class="list">
            <div class="list-item">Daily Report</div>
            <div class="list-item">Weekly Report</div>
            <div class="list-item">Monthly Report</div>
          </div>
        </div>
        <div class="card">
          <h3>CSV Export</h3>
          <p>Export data in CSV format.</p>
          <button class="btn" onclick="downloadFile('/api/export/csv')">Generate CSV Report</button>
        </div>
        <div class="card">
          <h3>PDF Export</h3>
          <p>Generate comprehensive PDF reports.</p>
          <button class="btn alt" onclick="downloadFile('/api/export/pdf')">Generate PDF Report</button>
        </div>
      </div>

      <div class="card" style="margin-top:16px;">
        <h3>Collection Records</h3>
        <table class="table" id="records-table">
          <thead><tr><th>Date</th><th>Dry</th><th>Wet</th><th>TDS</th><th>Temp</th><th>AQ (PPM)</th><th>GPS</th><th>Status</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- Heatmap -->
    <section id="heatmap">
      <div class="card">
        <div class="flex" style="justify-content: space-between; align-items: center;">
          <h3>Heatmap Analysis</h3>
          <button class="btn alt" onclick="downloadFile('/api/export/csv')">Export Heatmap</button>
        </div>
        <div class="layer-toggle" style="margin:10px 0;">
          <span class="pill active">Dry Waste Density</span>
          <span class="pill">Wet Waste Density</span>
          <span class="pill">Pollution Heatmap (TDS + AQI)</span>
        </div>
        <div id="heatmap"></div>
      </div>
    </section>

    <!-- About -->
    <section id="about">
      <div class="card">
        <h3>About the Project</h3>
        <p><strong>Mission:</strong> Deliver a resilient, low-cost autonomous waste-segregation platform for Urban Local Bodies.</p>
        <p><strong>Hardware:</strong> ESP32-CAM (image), ESP8266 (MQ135, MQ2, TDS, DS18B20, GPS, HMC5883L, moisture, ultrasonic, HX711), L298N drivers for conveyors & propellers.</p>
        <p><strong>Why better:</strong> Real-time IoT + AI loop, dual-bin moisture-aware conveyors, hazardous detection, obstacle & tilt protection, exportable evidence packs.</p>
      </div>
    </section>
  </main>

  <script src="./app.js"></script>
</body>
</html>
<!-- frontend/index.html -->
<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>PAVITRAX | Smart Waste-Segregation Boat</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>
  <style>
    :root {
      --primary: #0b4f6c;
      --secondary: #1f8a70;
      --bg: #f4f6f8;
      --card: #ffffff;
      --text: #0f172a;
      --muted: #6b7280;
      --accent: #f59e0b;
      --danger: #dc2626;
      --success: #16a34a;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: "Inter", Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
    }
    header {
      background: linear-gradient(135deg, var(--primary), #07354b);
      color: #fff;
      padding: 20px 32px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 12px;
    }
    header h1 { margin: 0; font-size: 20px; letter-spacing: 0.5px; }
    header .meta { font-size: 12px; color: #dbeafe; }
    nav {
      background: #fff;
      display: flex;
      gap: 12px;
      padding: 10px 20px;
      border-bottom: 1px solid #e5e7eb;
      position: sticky;
      top: 0;
      z-index: 10;
    }
    nav button {
      border: 1px solid #e5e7eb;
      background: #f8fafc;
      border-radius: 8px;
      padding: 10px 14px;
      font-weight: 600;
      color: var(--text);
      cursor: pointer;
      transition: all .15s ease;
    }
    nav button.active { background: var(--primary); color: #fff; border-color: var(--primary); }
    nav button:hover { transform: translateY(-1px); }
    main { padding: 20px; }
    section { display: none; }
    section.active { display: block; }
    .grid { display: grid; gap: 16px; }
    .cards-4 { grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); }
    .card {
      background: var(--card);
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      padding: 16px;
      box-shadow: 0 6px 18px rgba(0,0,0,0.04);
    }
    .card h3 { margin: 0 0 6px; font-size: 14px; color: var(--muted); text-transform: uppercase; letter-spacing: 0.8px; }
    .card .value { font-size: 24px; font-weight: 700; }
    .pill { padding: 4px 10px; border-radius: 999px; font-size: 12px; display: inline-block; }
    .pill.success { background: #ecfdf3; color: var(--success); }
    .pill.warn { background: #fff7ed; color: var(--accent); }
    .pill.danger { background: #fef2f2; color: var(--danger); }
    .controls button {
      border: none;
      background: var(--primary);
      color: #fff;
      border-radius: 10px;
      padding: 12px;
      cursor: pointer;
      font-weight: 600;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
      transition: background .1s ease, transform .1s ease;
    }
    .controls button.alt { background: var(--secondary); }
    .controls button.danger { background: var(--danger); }
    .controls button:hover { transform: translateY(-1px); }
    #map, #heatmap { width: 100%; height: 360px; border-radius: 12px; }
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 10px; border-bottom: 1px solid #e5e7eb; text-align: left; font-size: 14px; }
    th { background: #f8fafc; color: var(--muted); font-weight: 700; }
    .badge { padding: 4px 8px; border-radius: 8px; font-size: 12px; }
    .alert { border-left: 4px solid var(--accent); padding: 10px; margin-bottom: 8px; background: #fffbeb; border-radius: 8px; }
    .two-col { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
    @media (max-width: 900px) {
      nav { flex-wrap: wrap; }
      .two-col { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <header>
    <div>
      <h1>PAVITRAX | ULB Command Dashboard</h1>
      <div class="meta">Autonomous smart waste-segregation boat • Live IoT + AI • Govt grade</div>
    </div>
    <div class="meta" id="last-update">Last update: --</div>
  </header>

  <nav id="nav">
    <button data-target="dashboard" class="active">Dashboard</button>
    <button data-target="classification">Waste Classification</button>
    <button data-target="heatmap">Heatmap</button>
    <button data-target="weekly">7-Day Analysis</button>
    <button data-target="notifications">Notifications</button>
    <button data-target="export">Data Export</button>
    <button data-target="about">About</button>
  </nav>

  <main>
    <section id="dashboard" class="active">
      <div class="grid cards-4">
        <div class="card"><h3>Boat Location (NEO-6M GPS) - ESP8266</h3><div class="value" id="boat-location">--</div><div class="meta" id="boat-heading">Compass (HMC5883L): --°</div></div>
        <div class="card"><h3>Speed</h3><div class="value" id="boat-speed">-- m/s</div><div class="meta">Propeller motors (L298N) - ESP8266</div></div>
        <div class="card"><h3>Ultrasonic (Waterproof) - ESP8266</h3><div class="value" id="ultrasonic">-- cm</div><span class="pill warn" id="obstacle-pill">Monitoring</span></div>
        <div class="card"><h3>Battery</h3><div class="value" id="battery">-- V</div><span class="pill" id="battery-pill">--</span></div>
        <div class="card"><h3>Air Quality (MQ135) - ESP8266</h3><div class="value" id="mq135-value">-- ppm</div><div class="meta" id="mq135-pollutants">NH₃, CO₂, NOx, C₆H₆, Benzene</div><span class="pill danger" id="pollution-pill">Monitoring</span></div>
        <div class="card"><h3>Air Quality (MQ2) - ESP8266</h3><div class="value" id="mq2-value">-- ppm</div><div class="meta" id="mq2-pollutants">Smoke, Alcohol, LPG, CH₄, Benzene</div></div>
        <div class="card"><h3>Water Temp (DS18B20) - ESP8266</h3><div class="value" id="temp">-- °C</div><div class="meta">Water temperature sensor</div></div>
        <div class="card"><h3>TDS (Water Health) - ESP8266</h3><div class="value" id="tds-value">-- ppm</div><div class="meta" id="tds-status">--</div><span class="pill" id="tds-pill">--</span></div>
        <div class="card"><h3>Moisture (Dry Bin) - ESP8266</h3><div class="value" id="moisture-dry">-- %</div><div class="meta">Capacitive soil moisture sensor</div></div>
        <div class="card"><h3>Moisture (Wet Bin) - ESP8266</h3><div class="value" id="moisture-wet">-- %</div><div class="meta">Capacitive soil moisture sensor</div></div>
        <div class="card"><h3>Bin Weight (HX711) - ESP8266</h3><div class="value" id="weight">-- g</div><span class="pill" id="bin-pill">Capacity ok</span></div>
        <div class="card"><h3>Conveyor Belts (L298N) - ESP8266</h3><div class="value" id="conveyors">Wet: -- | Dry: --</div><div class="meta">2 motors via L298N driver</div></div>
        <div class="card"><h3>Propeller Motors (L298N) - ESP8266</h3><div class="value" id="propellers">Status: --</div><div class="meta">2 gear motors via L298N</div></div>
        <div class="card"><h3>Mode</h3><div class="value" id="mode">--</div><div class="meta" id="image-status">ESP32-CAM: Image Processing Only</div></div>
      </div>

      <div class="two-col" style="margin-top:16px;">
        <div class="card">
          <h3>Boat Map</h3>
          <div id="map"></div>
        </div>
        <div class="card">
          <h3>Stability (ADX)</h3>
          <canvas id="stabilityChart" height="150"></canvas>
        </div>
      </div>

      <div class="card" style="margin-top:16px;">
        <h3>Controls</h3>
        <div class="controls" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:10px;">
          <button onclick="sendCommand({action:'forward'})">Move Forward</button>
          <button onclick="sendCommand({action:'left'})">Move Left</button>
          <button onclick="sendCommand({action:'right'})">Move Right</button>
          <button class="danger" onclick="sendCommand({action:'stop'})">Stop</button>
          <button class="alt" onclick="sendCommand({belt:'wet_on'})">Conveyor Wet</button>
          <button class="alt" onclick="sendCommand({belt:'dry_on'})">Conveyor Dry</button>
          <button onclick="sendCommand({mode:'autonomous_toggle'})">Auto Segregation</button>
          <button onclick="sendCommand({mode:'navigation_toggle'})">Auto Navigation</button>
        </div>
      </div>
    </section>

    <section id="classification">
      <div class="card">
        <h3>YOLOv8n Results (latest)</h3>
        <div class="grid cards-4">
          <div class="card"><h3>Dry</h3><div class="value" id="stat-dry">--</div></div>
          <div class="card"><h3>Wet</h3><div class="value" id="stat-wet">--</div></div>
          <div class="card"><h3>Hazardous</h3><div class="value" id="stat-hazard">--</div><span class="pill danger" id="hazard-flag">Monitoring</span></div>
          <div class="card"><h3>Metal/Plastic</h3><div class="value" id="stat-metal">--</div></div>
        </div>
        <div class="two-col" style="margin-top:12px;">
          <div class="card">
            <h3>Hazard Monitor (ESP32-CAM)</h3>
            <div class="value" id="latest-hazard">--</div>
            <div class="meta">Latest hazardous waste detection from ESP32-CAM</div>
            <div class="meta" id="image-processing-status" style="margin-top:8px;font-size:11px;">ESP32-CAM: Image Processing Only</div>
          </div>
          <div class="card">
            <h3>Water Health Analysis (ESP8266)</h3>
            <div class="value" id="water-health-status">--</div>
            <div class="meta" id="water-health-detail" style="margin-top:4px;">TDS-based water quality assessment</div>
            <div class="meta" id="pollution-zone" style="margin-top:4px;font-size:11px;">Zone: --</div>
            <div class="meta" style="margin-top:4px;font-size:11px;">Before/After collection monitoring</div>
          </div>
        </div>
        <div class="card" style="margin-top:12px;">
          <h3>Environmental Risk Indicators</h3>
          <div class="grid cards-4">
            <div class="card"><h3>Algal Bloom Risk</h3><div class="value" id="algal-risk">--</div><div class="meta">Based on TDS + Temp (ESP8266)</div></div>
            <div class="card"><h3>Sewage/Industrial Discharge</h3><div class="value" id="sewage-risk">--</div><div class="meta">High TDS indicator (ESP8266)</div></div>
            <div class="card"><h3>Plastic Zone (Low TDS)</h3><div class="value" id="plastic-zone">--</div><div class="meta">TDS &lt; 50 ppm (ESP8266)</div></div>
            <div class="card"><h3>Chemical Zone (High TDS)</h3><div class="value" id="chemical-zone">--</div><div class="meta">TDS &gt; 500 ppm (ESP8266)</div></div>
          </div>
        </div>
        <table id="classification-table" style="margin-top:12px;">
          <thead><tr><th>Type</th><th>Count</th><th>Avg Confidence</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <section id="heatmap">
      <div class="card">
        <h3>Waste Density Heatmap</h3>
        <div id="heatmap"></div>
      </div>
    </section>

    <section id="weekly">
      <div class="two-col">
        <div class="card">
          <h3>Waste Collected (7-day)</h3>
          <canvas id="weeklyChart" height="160"></canvas>
        </div>
        <div class="card">
          <h3>Environmental Trends</h3>
          <canvas id="envChart" height="160"></canvas>
        </div>
      </div>
    </section>

    <section id="notifications">
      <div class="card">
        <h3>Live Alerts</h3>
        <div id="alerts"></div>
      </div>
    </section>

    <section id="export">
      <div class="card">
        <h3>Data Export</h3>
        <p>Download ready-to-share CSV/PDF with charts and statistics.</p>
        <div class="controls" style="display:flex;gap:12px;flex-wrap:wrap;">
          <button onclick="downloadFile('/api/export/csv')">Download CSV</button>
          <button class="alt" onclick="downloadFile('/api/export/pdf')">Download PDF</button>
        </div>
      </div>
    </section>

    <section id="about">
      <div class="card">
        <h3>About the Project</h3>
        <p><strong>Mission:</strong> Deliver a resilient, low-cost autonomous waste-segregation platform for Urban Local Bodies, compliant with SIH mandates.</p>
        <p><strong>Team:</strong> Robotics + AI + Embedded + Cloud working with NEO6M, HMC5883L, JSN-SR04T, HX711, MQ2, MQ135, DS18B20, LJ12A3, ADX, dual conveyors and propellers.</p>
        <p><strong>Why better:</strong> Real-time IoT + AI loop, dual-bin moisture-aware conveyors, hazardous detection, obstacle & tilt protection, exportable evidence packs, sub-₹2500 electronics (excluding hull).</p>
        <p><strong>Future scope:</strong> Fleet orchestration, predictive routing, SLA dashboards, auto-reports to pollution boards, integration with city open-data portals.</p>
      </div>
    </section>
  </main>

  <script>
    const API_BASE = location.origin.includes('3000') ? location.origin.replace('3000','4000') : location.origin;
    let map, heatLayer, stabilityChart, weeklyChart, envChart, socket;
    const stabilityData = { labels: [], x: [], y: [], z: [] };

    function setActive(target) {
      document.querySelectorAll('nav button').forEach(btn => btn.classList.toggle('active', btn.dataset.target === target));
      document.querySelectorAll('main section').forEach(sec => sec.classList.toggle('active', sec.id === target));
    }
    document.getElementById('nav').addEventListener('click', (e) => {
      if (e.target.tagName === 'BUTTON') setActive(e.target.dataset.target);
    });

    function updateCards(data) {
      // GPS & Compass (NEO-6M & HMC5883L)
      const loc = data.gps?.lat ? `${data.gps.lat.toFixed(5)}, ${data.gps.lon?.toFixed(5)}` : '--';
      document.getElementById('boat-location').innerText = loc;
      document.getElementById('boat-heading').innerText = `Compass (HMC5883L): ${data.heading ?? '--'}°`;
      document.getElementById('boat-speed').innerText = `${data.speed ?? '--'} m/s`;
      
      // Ultrasonic (JSN-SR04T)
      document.getElementById('ultrasonic').innerText = `${data.ultrasonic_cm ?? '--'} cm`;
      
      // Battery
      document.getElementById('battery').innerText = `${data.battery_volt ?? '--'} V`;
      document.getElementById('battery-pill').innerText = (data.battery_volt || 0) < 10.8 ? 'Low battery' : 'Healthy';
      document.getElementById('battery-pill').className = 'pill ' + ((data.battery_volt || 0) < 10.8 ? 'danger' : 'success');
      
      // Air Quality Sensors (ESP8266)
      const mq135 = data.mq135_ppm ?? data.gas?.mq135 ?? '--';
      const mq2 = data.mq2_ppm ?? data.gas?.mq2 ?? '--';
      document.getElementById('mq135-value').innerText = `${mq135} ppm`;
      document.getElementById('mq2-value').innerText = `${mq2} ppm`;
      
      // Update pollutant details
      if (mq135 !== '--') {
        document.getElementById('mq135-pollutants').innerText = `NH₃, CO₂, NOx, C₆H₆, Smoke, Alcohol`;
      }
      if (mq2 !== '--') {
        document.getElementById('mq2-pollutants').innerText = `Smoke, Alcohol, LPG, CH₄, Benzene`;
      }
      
      // Update pollution pill based on MQ135
      if (mq135 !== '--' && mq135 > 400) {
        document.getElementById('pollution-pill').innerText = 'High pollution';
        document.getElementById('pollution-pill').className = 'pill danger';
      } else if (mq135 !== '--' && mq135 > 200) {
        document.getElementById('pollution-pill').innerText = 'Moderate';
        document.getElementById('pollution-pill').className = 'pill warn';
      } else {
        document.getElementById('pollution-pill').innerText = 'Normal';
        document.getElementById('pollution-pill').className = 'pill success';
      }
      
      // Temperature (DS18B20)
      document.getElementById('temp').innerText = `${data.temperature_c ?? '--'} °C`;
      
      // TDS Sensor (Water Health)
      const tds = data.tds_ppm ?? data.tds ?? '--';
      document.getElementById('tds-value').innerText = `${tds} ppm`;
      
      // Water Health Analysis based on TDS
      if (tds !== '--') {
        let status = '';
        let detail = '';
        let pillClass = 'pill';
        let zone = '';
        
        if (tds < 50) {
          status = 'Excellent';
          detail = 'Very clean water, likely plastic accumulation zone';
          pillClass = 'pill success';
          zone = 'Plastic Zone (Low TDS)';
          document.getElementById('plastic-zone').innerText = 'Detected';
        } else if (tds < 200) {
          status = 'Good';
          detail = 'Acceptable water quality';
          pillClass = 'pill success';
          zone = 'Normal Zone';
        } else if (tds < 500) {
          status = 'Fair';
          detail = 'Moderate dissolved solids';
          pillClass = 'pill warn';
          zone = 'Moderate Pollution';
        } else if (tds < 1000) {
          status = 'Poor';
          detail = 'High TDS - Possible sewage/industrial discharge';
          pillClass = 'pill danger';
          zone = 'Chemical Pollution Zone (High TDS)';
          document.getElementById('sewage-risk').innerText = 'High Risk';
          document.getElementById('chemical-zone').innerText = 'Detected';
        } else {
          status = 'Critical';
          detail = 'Very high TDS - Severe pollution, algal bloom risk';
          pillClass = 'pill danger';
          zone = 'Critical Pollution Zone';
          document.getElementById('sewage-risk').innerText = 'Critical';
          document.getElementById('algal-risk').innerText = 'High Risk';
          document.getElementById('chemical-zone').innerText = 'Critical';
        }
        
        document.getElementById('tds-status').innerText = status;
        document.getElementById('tds-pill').innerText = status;
        document.getElementById('tds-pill').className = pillClass;
        document.getElementById('water-health-status').innerText = status;
        document.getElementById('water-health-detail').innerText = detail;
        document.getElementById('pollution-zone').innerText = zone;
        
        // Algal bloom risk (high TDS + high temp)
        if (tds > 500 && (data.temperature_c || 0) > 25) {
          document.getElementById('algal-risk').innerText = 'High Risk';
        } else if (tds > 300 && (data.temperature_c || 0) > 22) {
          document.getElementById('algal-risk').innerText = 'Moderate';
        } else {
          document.getElementById('algal-risk').innerText = 'Low';
        }
      } else {
        document.getElementById('tds-status').innerText = 'No data';
        document.getElementById('tds-pill').innerText = '--';
        document.getElementById('water-health-status').innerText = '--';
        document.getElementById('water-health-detail').innerText = 'TDS sensor data unavailable';
      }
      
      // Moisture Sensors (Capacitive)
      document.getElementById('moisture-dry').innerText = `${data.moisture?.dry_bin ?? '--'}%`;
      document.getElementById('moisture-wet').innerText = `${data.moisture?.wet_bin ?? '--'}%`;
      
      // Load Cell (HX711)
      document.getElementById('weight').innerText = `${data.loadcell_grams ?? '--'} g`;
      document.getElementById('bin-pill').innerText = (data.loadcell_grams || 0) > 4500 ? 'Bin full' : 'Capacity ok';
      document.getElementById('bin-pill').className = 'pill ' + ((data.loadcell_grams || 0) > 4500 ? 'danger' : 'success');
      
      // Conveyor Belts (L298N) - ESP8266
      document.getElementById('conveyors').innerText = `Wet: ${data.conveyor?.wet_active ? 'ON' : 'OFF'} | Dry: ${data.conveyor?.dry_active ? 'ON' : 'OFF'}`;
      
      // Propeller Motors (L298N) - ESP8266
      const propStatus = data.propeller?.active ? 'Active' : 'Idle';
      document.getElementById('propellers').innerText = `Status: ${propStatus}`;
      
      // Mode & ESP32-CAM Status
      document.getElementById('mode').innerText = data.mode?.autonomous ? 'Autonomous' : 'Manual';
      const camStatus = data.waste?.type ? 'Processing Images' : 'Idle';
      document.getElementById('image-status').innerText = `ESP32-CAM: ${camStatus} (Image Processing Only)`;
      
      document.getElementById('last-update').innerText = `Last update: ${new Date().toLocaleTimeString()}`;
      
      // Hazardous waste detection (from ESP32-CAM)
      if (data.waste?.type && String(data.waste.type).toLowerCase().includes('hazard')) {
        document.getElementById('latest-hazard').innerText = `Hazardous: ${data.waste.type} (${(data.waste.confidence || 0).toFixed(2)})`;
        document.getElementById('hazard-flag').innerText = 'Hazard detected';
        document.getElementById('hazard-flag').className = 'pill danger';
        document.getElementById('image-processing-status').innerText = 'Image processing: Hazard detected!';
      } else if (data.waste?.type) {
        document.getElementById('latest-hazard').innerText = `${data.waste.type} (${(data.waste.confidence || 0).toFixed(2)})`;
        document.getElementById('image-processing-status').innerText = 'Image processing: Active';
      } else {
        document.getElementById('latest-hazard').innerText = 'No detection';
        document.getElementById('image-processing-status').innerText = 'Image processing: Waiting...';
      }
      
      // Obstacle detection
      if ((data.ultrasonic_cm || 999) < 25) {
        document.getElementById('obstacle-pill').innerText = 'Obstacle detected!';
        document.getElementById('obstacle-pill').className = 'pill danger';
      } else {
        document.getElementById('obstacle-pill').innerText = 'Clear';
        document.getElementById('obstacle-pill').className = 'pill success';
      }
    }

    function updateStability(acc) {
      const ts = new Date().toLocaleTimeString();
      stabilityData.labels.push(ts);
      stabilityData.x.push(acc?.x ?? 0);
      stabilityData.y.push(acc?.y ?? 0);
      stabilityData.z.push(acc?.z ?? 0);
      if (stabilityData.labels.length > 30) {
        stabilityData.labels.shift(); stabilityData.x.shift(); stabilityData.y.shift(); stabilityData.z.shift();
      }
      stabilityChart.data.labels = stabilityData.labels;
      stabilityChart.data.datasets[0].data = stabilityData.x;
      stabilityChart.data.datasets[1].data = stabilityData.y;
      stabilityChart.data.datasets[2].data = stabilityData.z;
      stabilityChart.update('none');
    }

    function sendCommand(cmd) {
      fetch(`${API_BASE}/api/control/send`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(cmd)
      }).catch(console.error);
      if (socket) socket.emit('command', cmd);
    }

    function downloadFile(path) {
      window.open(`${API_BASE}${path}`, '_blank');
    }

    async function fetchJson(path) {
      const res = await fetch(`${API_BASE}${path}`);
      return res.json();
    }

    async function loadClassification() {
      const data = await fetchJson('/api/analytics/classification');
      const tbody = document.querySelector('#classification-table tbody');
      tbody.innerHTML = '';
      const counts = { dry: 0, wet: 0, hazardous: 0, metal: 0 };
      (data.data || []).forEach(row => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${row._id || 'unknown'}</td><td>${row.count}</td><td>${(row.avgConfidence||0).toFixed(2)}</td>`;
        tbody.appendChild(tr);
        const t = (row._id || '').toLowerCase();
        if (t.includes('wet')) counts.wet = row.count;
        else if (t.includes('hazard')) counts.hazardous = row.count;
        else if (t.includes('metal') || t.includes('plastic')) counts.metal = row.count;
        else counts.dry += row.count;
      });
      document.getElementById('stat-dry').innerText = counts.dry;
      document.getElementById('stat-wet').innerText = counts.wet;
      document.getElementById('stat-hazard').innerText = counts.hazardous;
      document.getElementById('stat-metal').innerText = counts.metal;
    }

    async function loadWeekly() {
      const data = await fetchJson('/api/analytics/weekly');
      const labels = data.data.map(d => d._id.day);
      const weights = data.data.map(d => d.totalWeight || 0);
      const wet = data.data.map(d => d.wet || 0);
      const dry = data.data.map(d => d.dry || 0);
      const haz = data.data.map(d => d.hazardous || 0);
      weeklyChart.data.labels = labels;
      weeklyChart.data.datasets[0].data = wet;
      weeklyChart.data.datasets[1].data = dry;
      weeklyChart.data.datasets[2].data = haz;
      weeklyChart.update('none');
      envChart.data.labels = labels;
      envChart.data.datasets[0].data = data.data.map(d => d.avgTemp || 0);
      envChart.data.datasets[1].data = data.data.map(d => d.avgGas || 0);
      envChart.update('none');
    }

    async function loadHeatmap() {
      const data = await fetchJson('/api/analytics/heatmap');
      if (!heatLayer) {
        heatLayer = L.heatLayer(data.data || [], { radius: 25 }).addTo(map);
      } else {
        heatLayer.setLatLngs(data.data || []);
      }
    }

    async function loadAlerts() {
      const data = await fetchJson('/api/alerts');
      const container = document.getElementById('alerts');
      container.innerHTML = '';
      (data.data || []).forEach(al => {
        const div = document.createElement('div');
        div.className = 'alert';
        div.innerHTML = `<strong>${al.type}</strong> • ${al.message} <div class="meta">${new Date(al.createdAt).toLocaleString()}</div>`;
        container.appendChild(div);
      });
    }

    function initCharts() {
      stabilityChart = new Chart(document.getElementById('stabilityChart'), {
        type: 'line',
        data: {
          labels: [],
          datasets: [
            { label: 'X', data: [], borderColor: '#2563eb', tension: 0.3 },
            { label: 'Y', data: [], borderColor: '#10b981', tension: 0.3 },
            { label: 'Z', data: [], borderColor: '#f59e0b', tension: 0.3 }
          ]
        },
        options: { plugins: { legend: { display: true } }, scales: { y: { suggestedMin: -2, suggestedMax: 2 } } }
      });
      weeklyChart = new Chart(document.getElementById('weeklyChart'), {
        type: 'bar',
        data: { labels: [], datasets: [
          { label: 'Wet', data: [], backgroundColor: '#10b981' },
          { label: 'Dry', data: [], backgroundColor: '#2563eb' },
          { label: 'Hazard', data: [], backgroundColor: '#f59e0b' }
        ]},
        options: { responsive: true, plugins: { legend: { position: 'bottom' } } }
      });
      envChart = new Chart(document.getElementById('envChart'), {
        type: 'line',
        data: { labels: [], datasets: [
          { label: 'Temperature °C', data: [], borderColor: '#dc2626', tension: 0.3 },
          { label: 'Gas MQ135', data: [], borderColor: '#0ea5e9', tension: 0.3 }
        ]},
        options: { plugins: { legend: { position: 'bottom' } } }
      });
    }

    function initMap() {
      map = L.map('map').setView([22.5726, 88.3639], 13);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(map);
      const marker = L.marker([22.5726, 88.3639]).addTo(map);
      return marker;
    }

    async function bootstrap() {
      initCharts();
      const marker = initMap();
      await loadClassification();
      await loadWeekly();
      await loadHeatmap();
      await loadAlerts();

      socket = io(API_BASE, { transports: ['websocket'] });
      socket.on('telemetry', (payload) => {
        const d = payload.data || {};
        updateCards(d);
        updateStability(d.accelerometer || {});
        if (d.lat && d.lon) {
          marker.setLatLng([d.lat, d.lon]);
          map.setView([d.lat, d.lon]);
        }
      });

      // initial pull in case websocket hasn't fired yet
      const latest = await fetchJson('/api/sensors/latest?n=1');
      if (latest.data && latest.data[0]) {
        updateCards(latest.data[0].data || {});
      }

      setInterval(loadClassification, 15000);
      setInterval(loadWeekly, 60000);
      setInterval(loadHeatmap, 20000);
      setInterval(loadAlerts, 30000);
    }

    bootstrap().catch(console.error);
  </script>
</body>
</html>
